{% extends 'school_management/base.html' %}

{% block title %}{{ quiz.quiz_name }} - 問題作成 - 学校管理システム{% endblock %}
{% block page_title %}{{ quiz.quiz_name }} - 問題作成{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-plus me-2"></i>新しい問題を作成</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    <!-- 問題文 -->
                    <div class="mb-3">
                        <label for="question_text" class="form-label">問題文 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="question_text" name="question_text" rows="3" required 
                                  placeholder="問題文を入力してください..."></textarea>
                    </div>
                    
                    <!-- 問題形式 -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="question_type" class="form-label">問題形式 <span class="text-danger">*</span></label>
                            <select class="form-select" id="question_type" name="question_type" required onchange="toggleQuestionFields()">
                                <option value="multiple_choice">選択問題</option>
                                <option value="true_false">正誤問題</option>
                                <option value="short_answer">記述問題</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="points" class="form-label">配点</label>
                            <input type="number" class="form-control" id="points" name="points" value="1" min="1" max="10">
                        </div>
                    </div>
                    
                    <!-- 選択問題用 -->
                    <div id="multiple_choice_fields" class="question-fields">
                        <label class="form-label">選択肢 <span class="text-danger">*</span></label>
                        <div id="choices_container">
                            <div class="input-group mb-2">
                                <div class="input-group-text">
                                    <input class="form-check-input" type="radio" name="correct_choice" value="0" checked>
                                </div>
                                <input type="text" class="form-control" name="choice_text" placeholder="選択肢1">
                                <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)" style="display:none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="input-group mb-2">
                                <div class="input-group-text">
                                    <input class="form-check-input" type="radio" name="correct_choice" value="1">
                                </div>
                                <input type="text" class="form-control" name="choice_text" placeholder="選択肢2">
                                <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)" style="display:none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addChoice()">
                            <i class="fas fa-plus me-1"></i>選択肢を追加
                        </button>
                    </div>
                    
                    <!-- 正誤問題用 -->
                    <div id="true_false_fields" class="question-fields" style="display:none;">
                        <label class="form-label">正解 <span class="text-danger">*</span></label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="correct_answer" id="answer_true" value="true" checked>
                            <label class="form-check-label" for="answer_true">正しい</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="correct_answer" id="answer_false" value="false">
                            <label class="form-check-label" for="answer_false">間違い</label>
                        </div>
                    </div>
                    
                    <!-- 記述問題用 -->
                    <div id="short_answer_fields" class="question-fields" style="display:none;">
                        <div class="mb-3">
                            <label for="correct_answer_text" class="form-label">模範解答（参考用）</label>
                            <textarea class="form-control" id="correct_answer_text" name="correct_answer" rows="2" 
                                      placeholder="採点の参考となる模範解答を入力（任意）"></textarea>
                            <small class="text-muted">記述問題は手動採点となります</small>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{% url 'school_management:question_manage' quiz.id %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>戻る
                        </a>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus me-1"></i>問題を作成
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- 既存問題一覧 -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-list me-2"></i>作成済み問題 ({{ questions.count }}問)</h6>
            </div>
            <div class="card-body">
                {% if questions %}
                    {% for question in questions %}
                    <div class="card border-secondary mb-2">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <small class="text-muted">問題{{ question.order }}</small>
                                    <p class="mb-1 small">{{ question.question_text|truncatechars:50 }}</p>
                                    <div class="d-flex gap-2">
                                        <span class="badge bg-info">{{ question.get_question_type_display }}</span>
                                        <span class="badge bg-primary">{{ question.points }}点</span>
                                    </div>
                                </div>
                                <button class="btn btn-outline-danger btn-sm" onclick="deleteQuestion({{ question.id }})" title="削除">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted text-center">問題がまだ作成されていません</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let choiceCount = 2;

function toggleQuestionFields() {
    const questionType = document.getElementById('question_type').value;
    const fields = document.querySelectorAll('.question-fields');
    
    fields.forEach(field => field.style.display = 'none');
    
    if (questionType === 'multiple_choice') {
        document.getElementById('multiple_choice_fields').style.display = 'block';
    } else if (questionType === 'true_false') {
        document.getElementById('true_false_fields').style.display = 'block';
    } else if (questionType === 'short_answer') {
        document.getElementById('short_answer_fields').style.display = 'block';
    }
}

function addChoice() {
    const container = document.getElementById('choices_container');
    const div = document.createElement('div');
    div.className = 'input-group mb-2';
    div.innerHTML = `
        <div class="input-group-text">
            <input class="form-check-input" type="radio" name="correct_choice" value="${choiceCount}">
        </div>
        <input type="text" class="form-control" name="choice_text" placeholder="選択肢${choiceCount + 1}">
        <button type="button" class="btn btn-outline-danger" onclick="removeChoice(this)">
            <i class="fas fa-times"></i>
        </button>
    `;
    container.appendChild(div);
    choiceCount++;
    
    // 削除ボタンを表示
    updateRemoveButtons();
}

function removeChoice(button) {
    button.closest('.input-group').remove();
    updateChoiceValues();
    updateRemoveButtons();
}

function updateChoiceValues() {
    const choices = document.querySelectorAll('#choices_container .input-group');
    choices.forEach((choice, index) => {
        const radio = choice.querySelector('input[type="radio"]');
        const input = choice.querySelector('input[type="text"]');
        radio.value = index;
        input.placeholder = `選択肢${index + 1}`;
    });
    choiceCount = choices.length;
}

function updateRemoveButtons() {
    const choices = document.querySelectorAll('#choices_container .input-group');
    const removeButtons = document.querySelectorAll('#choices_container .btn-outline-danger');
    
    if (choices.length > 2) {
        removeButtons.forEach(btn => btn.style.display = 'block');
    } else {
        removeButtons.forEach(btn => btn.style.display = 'none');
    }
}

function deleteQuestion(questionId) {
    if (confirm('この問題を削除しますか？この操作は取り消せません。')) {
        // TODO: AJAX実装で削除機能を追加
        alert('削除機能は今後実装予定です');
    }
}

// ページ読み込み時の初期化
document.addEventListener('DOMContentLoaded', function() {
    toggleQuestionFields();
    updateRemoveButtons();
});
</script>
{% endblock %}
