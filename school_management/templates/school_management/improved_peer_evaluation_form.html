{% load static %}
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ピア評価フォーム - {{ lesson_session.classroom.class_name }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- ヘッダー -->
                <div class="card mb-4">
                    <div class="card-body text-center">
                        <h2 class="text-primary mb-3">
                            <i class="fas fa-users-cog me-2"></i>グループワーク ピア評価フォーム
                        </h2>
                        <div class="row">
                            <div class="col-md-6">
                                <strong>クラス:</strong> {{ lesson_session.classroom.class_name }}<br>
                                <strong>授業回:</strong> 第{{ lesson_session.session_number }}回
                            </div>
                            <div class="col-md-6">
                                <strong>実施日:</strong> {{ lesson_session.date|date:"Y年m月d日" }}<br>
                                {% if lesson_session.topic %}
                                    <strong>トピック:</strong> {{ lesson_session.topic }}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 評価が締め切られている場合の表示 -->
                {% if is_closed %}
                <div class="alert alert-warning text-center">
                    <h4><i class="fas fa-lock me-2"></i>評価期限が終了しました</h4>
                    <p class="mb-0">この評価は既に締め切られています。</p>
                </div>
                {% else %}

                <!-- 注意事項 -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>このフォームについて</h6>
                    <p class="mb-2">
                        このフォームは、グループワークにおけるメンバーの貢献度を匿名で評価するためのものです。
                        あなたの率直な意見が、今後の授業改善やメンバーへのフィードバックに活用されます。
                    </p>
                    <p class="mb-0">
                        <strong>※評価は匿名です。名前は記録されません。</strong>
                    </p>
                </div>

                <!-- グループが設定されていない場合 -->
                {% if not groups %}
                <div class="alert alert-warning text-center">
                    <h4><i class="fas fa-exclamation-triangle me-2"></i>グループが設定されていません</h4>
                    <p class="mb-0">まだグループが編成されていません。担当教員にお問い合わせください。</p>
                </div>
                {% else %}

                <form method="post" id="evaluationForm">
                    {% csrf_token %}
                    
                    <!-- 自分のグループ選択 -->
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-users me-2"></i>あなたのグループ</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-3">あなたが所属するグループを選択してください。</p>
                            <div class="row">
                                {% for group in groups %}
                                <div class="col-md-6 col-lg-4 mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="evaluator_group" 
                                               id="group_{{ group.id }}" value="{{ group.id }}" 
                                               onchange="loadGroupMembers({{ group.id }})" required>
                                        <label class="form-check-label" for="group_{{ group.id }}">
                                            <div class="card h-100">
                                                <div class="card-body p-3">
                                                    <h6 class="text-primary mb-2">
                                                        {% if group.group_name %}
                                                            {{ group.group_name }} ({{ group.group_number }}グループ)
                                                        {% else %}
                                                            {{ group.group_number }}グループ
                                                        {% endif %}
                                                    </h6>
                                                    <div class="small text-muted">
                                                        {% for member in group.groupmember_set.all %}
                                                            {{ member.student.full_name }}{% if not forloop.last %}, {% endif %}
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>

                    <!-- 今日参加したメンバーの選択と貢献度評価 -->
                    <div class="card mb-4" id="memberEvaluationCard" style="display: none;">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0"><i class="fas fa-star me-2"></i>メンバー貢献度評価</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">今日のグループワークに参加したメンバーを選択し、その貢献度を評価してください。</p>
                            
                            <!-- 参加者数 -->
                            <div class="mb-4">
                                <label class="form-label"><strong>今日参加したメンバー数（あなたを含む）</strong></label>
                                <select class="form-select" id="participantCount" name="participant_count" onchange="updateParticipantSelection()">
                                    <option value="">選択してください</option>
                                    <option value="1">1名（自分のみ）</option>
                                    <option value="2">2名</option>
                                    <option value="3">3名</option>
                                    <option value="4">4名</option>
                                    <option value="5">5名</option>
                                    <option value="6">6名</option>
                                    <option value="7">7名</option>
                                </select>
                                <div class="form-text">※2名以上の場合、自分以外のメンバーを評価します。1名の場合はメンバー評価はスキップされます。</div>
                            </div>

                            <!-- 動的に生成される参加メンバー選択と評価フォーム -->
                            <div id="participantEvaluationContainer"></div>
                        </div>
                    </div>

                    <!-- 他グループ評価 -->
                    <div class="card mb-4">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class="fas fa-trophy me-2"></i>他グループ評価</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted mb-4">発表内容やアイデアの良さを基準に、他グループのランキングを付けてください。</p>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="first_place_group" class="form-label">
                                        <i class="fas fa-medal text-warning me-2"></i><strong>1位のグループ</strong>
                                    </label>
                                    <select class="form-select" id="first_place_group" name="first_place_group" required onchange="updateSecondPlaceOptions()">
                                        <option value="">選択してください</option>
                                        {% for group in groups %}
                                            <option value="{{ group.id }}">
                                                {% if group.group_name %}
                                                    {{ group.group_name }} ({{ group.group_number }}グループ)
                                                {% else %}
                                                    {{ group.group_number }}グループ
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="mt-2">
                                        <label for="first_place_reason" class="form-label">理由（任意）</label>
                                        <textarea class="form-control" id="first_place_reason" name="first_place_reason" rows="2" 
                                                  placeholder="1位に選んだ理由を簡潔に記入してください"></textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                    <label for="second_place_group" class="form-label">
                                        <i class="fas fa-medal text-secondary me-2"></i><strong>2位のグループ</strong>
                                    </label>
                                    <select class="form-select" id="second_place_group" name="second_place_group" required onchange="updateFirstPlaceOptions()">
                                        <option value="">選択してください</option>
                                        {% for group in groups %}
                                            <option value="{{ group.id }}">
                                                {% if group.group_name %}
                                                    {{ group.group_name }} ({{ group.group_number }}グループ)
                                                {% else %}
                                                    {{ group.group_number }}グループ
                                                {% endif %}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <div class="mt-2">
                                        <label for="second_place_reason" class="form-label">理由（任意）</label>
                                        <textarea class="form-control" id="second_place_reason" name="second_place_reason" rows="2" 
                                                  placeholder="2位に選んだ理由を簡潔に記入してください"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 全体コメント -->
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-comment me-2"></i>全体コメント（任意）</h5>
                        </div>
                        <div class="card-body">
                            <textarea class="form-control" id="general_comment" name="general_comment" rows="4" 
                                      placeholder="今日のグループワークや授業全体について、感想やコメントがあれば記入してください"></textarea>
                        </div>
                    </div>

                    <!-- 進捗表示 -->
                    <div class="card mb-4" id="progressCard">
                        <div class="card-header">
                            <h6><i class="fas fa-tasks me-2"></i>入力進捗</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="form-check" id="progressGroup">
                                        <input class="form-check-input" type="checkbox" disabled>
                                        <label class="form-check-label">グループ選択</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="form-check" id="progressMembers">
                                        <input class="form-check-input" type="checkbox" disabled>
                                        <label class="form-check-label">メンバー評価</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="form-check" id="progressFirst">
                                        <input class="form-check-input" type="checkbox" disabled>
                                        <label class="form-check-label">1位選択</label>
                                    </div>
                                </div>
                                <div class="col-md-3 col-6 mb-2">
                                    <div class="form-check" id="progressSecond">
                                        <input class="form-check-input" type="checkbox" disabled>
                                        <label class="form-check-label">2位選択</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 提出ボタン -->
                    <div class="text-center mb-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="submitButton" disabled>
                            <i class="fas fa-paper-plane me-2"></i>評価を提出する
                        </button>
                    </div>
                </form>
                
                {% endif %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- グループ情報をJavaScriptで利用するためのJSONデータ -->
    {% if groups and not is_closed %}
    <script type="application/json" id="groups-data">
        {{ groups_json|safe }}
    </script>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    {% if groups and not is_closed %}
    <script>
    // グループデータを取得
    const groupsData = JSON.parse(document.getElementById('groups-data').textContent);
    
    function loadGroupMembers(groupId) {
        // メンバー評価カードを表示
        document.getElementById('memberEvaluationCard').style.display = 'block';
        
        // 参加者数選択肢を動的に更新
        const group = groupsData.find(g => g.id == groupId);
        if (group) {
            updateParticipantCountOptions(group.members.length);
        }
        
        // 進捗更新
        updateProgress();
    }
    
    // 参加者数選択肢を動的に更新
    function updateParticipantCountOptions(groupMemberCount) {
        const participantCountSelect = document.getElementById('participantCount');
        const currentValue = participantCountSelect.value;
        
        // 既存のオプションをクリア
        participantCountSelect.innerHTML = '<option value="">選択してください</option>';
        
        // グループのメンバー数に基づいてオプションを生成
        for (let i = 1; i <= groupMemberCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            if (i === 1) {
                option.textContent = '1名（自分のみ）';
            } else {
                option.textContent = `${i}名`;
            }
            participantCountSelect.appendChild(option);
        }
        
        // 以前の選択値を復元（有効な場合のみ）
        if (currentValue && parseInt(currentValue) <= groupMemberCount) {
            participantCountSelect.value = currentValue;
        }
    }

    function updateParticipantSelection() {
        const count = parseInt(document.getElementById('participantCount').value);
        const selectedGroupId = document.querySelector('input[name="evaluator_group"]:checked')?.value;
        
        if (!selectedGroupId || !count) return;
        
        const group = groupsData.find(g => g.id == selectedGroupId);
        const container = document.getElementById('participantEvaluationContainer');
        
        let html = '<h6 class="mb-3">参加メンバーの選択と貢献度評価</h6>';
        
        // グループのメンバー数をチェック
        const groupMemberCount = group.members.length;
        
        // 1名の場合（自分のみ）
        if (count === 1) {
            html += `<div class="alert alert-warning mb-3">
                        <i class="fas fa-user me-2"></i>
                        参加メンバー数: 1名（自分のみ）→ メンバー評価はスキップされます
                     </div>
                     <div class="text-center py-4">
                        <i class="fas fa-user-check fa-3x text-muted mb-3"></i>
                        <p class="text-muted">自分一人での参加のため、メンバー貢献度評価はありません。</p>
                        <p class="text-muted">グループ評価と全体コメントのみ入力してください。</p>
                     </div>`;
        } else {
            // グループの人数を超えている場合はエラー表示
            if (count > groupMemberCount) {
                html += `<div class="alert alert-danger mb-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            エラー: 選択した参加者数（${count}名）がグループのメンバー数（${groupMemberCount}名）を超えています。
                         </div>
                         <div class="text-center py-4">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">参加者数をグループのメンバー数以下に調整してください。</p>
                            <p class="text-muted">グループ「${group.name}」のメンバー数: ${groupMemberCount}名</p>
                         </div>`;
            } else {
                // 2名以上の場合（自分以外を評価）
                const evaluationCount = count - 1;
                
                html += `<div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            参加メンバー数: ${count}名 → 評価対象: ${evaluationCount}名（自分以外のメンバーを評価してください）
                         </div>`;
                
                for (let i = 0; i < evaluationCount; i++) {
                    html += `
                        <div class="border rounded p-3 mb-3">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label"><strong>${i + 1}人目のメンバー（自分以外）</strong></label>
                                    <select class="form-select" name="participant_${i}_member" required onchange="updateMemberSelection()">
                                        <option value="">選択してください</option>`;
                    
                    group.members.forEach(member => {
                        html += `<option value="${member.id}">${member.name}</option>`;
                    });
                    
                    html += `
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label"><strong>貢献度評価</strong></label>
                                    <div class="btn-group-vertical d-grid" role="group">
                                        <input type="radio" class="btn-check" name="participant_${i}_contribution" id="contrib_${i}_5" value="5">
                                        <label class="btn btn-outline-success" for="contrib_${i}_5">5：非常に積極的だった</label>
                                        
                                        <input type="radio" class="btn-check" name="participant_${i}_contribution" id="contrib_${i}_4" value="4">
                                        <label class="btn btn-outline-primary" for="contrib_${i}_4">4：積極的だった</label>
                                        
                                        <input type="radio" class="btn-check" name="participant_${i}_contribution" id="contrib_${i}_3" value="3">
                                        <label class="btn btn-outline-secondary" for="contrib_${i}_3">3：普通だった</label>
                                        
                                        <input type="radio" class="btn-check" name="participant_${i}_contribution" id="contrib_${i}_2" value="2">
                                        <label class="btn btn-outline-warning" for="contrib_${i}_2">2：あまり貢献していなかった</label>
                                        
                                        <input type="radio" class="btn-check" name="participant_${i}_contribution" id="contrib_${i}_1" value="1">
                                        <label class="btn btn-outline-danger" for="contrib_${i}_1">1：全く貢献していなかった</label>
                                    </div>
                                </div>
                            </div>
                        </div>`;
                }
            }
        }
        
        container.innerHTML = html;
        updateProgress();
    }

    // メンバー選択の重複チェック
    function updateMemberSelection() {
        const selectedGroupId = document.querySelector('input[name="evaluator_group"]:checked')?.value;
        if (!selectedGroupId) return;
        
        const group = groupsData.find(g => g.id == selectedGroupId);
        const count = parseInt(document.getElementById('participantCount').value);
        
        // グループのメンバー数をチェック
        if (count > group.members.length) {
            return; // グループの人数を超えている場合は処理をスキップ
        }
        
        const evaluationCount = count - 1;
        
        // 選択されたメンバーIDを収集
        const selectedMembers = [];
        for (let i = 0; i < evaluationCount; i++) {
            const select = document.querySelector(`select[name="participant_${i}_member"]`);
            if (select && select.value) {
                selectedMembers.push(select.value);
            }
        }
        
        // 各選択肢を更新
        for (let i = 0; i < evaluationCount; i++) {
            const select = document.querySelector(`select[name="participant_${i}_member"]`);
            if (!select) continue;
            
            const currentValue = select.value;
            const currentIndex = i;
            
            // 選択肢をリセット
            select.innerHTML = '<option value="">選択してください</option>';
            
            // 利用可能なメンバーを追加
            group.members.forEach(member => {
                // 現在の選択肢以外で選択されていないメンバーのみ追加
                const isSelected = selectedMembers.includes(member.id) && selectedMembers.indexOf(member.id) !== currentIndex;
                if (!isSelected) {
                    const option = document.createElement('option');
                    option.value = member.id;
                    option.textContent = member.name;
                    select.appendChild(option);
                }
            });
            
            // 現在の選択を復元
            if (currentValue) {
                select.value = currentValue;
            }
        }
        
        // 進捗を更新
        updateProgress();
    }

    function updateProgress() {
        // グループ選択チェック
        const groupSelected = document.querySelector('input[name="evaluator_group"]:checked');
        document.querySelector('#progressGroup input').checked = !!groupSelected;
        
        // メンバー評価チェック
        const participantCount = document.getElementById('participantCount').value;
        let membersComplete = false;
        if (participantCount) {
            const count = parseInt(participantCount);
            if (count === 1) {
                // 1名の場合はメンバー評価をスキップ
                membersComplete = true;
            } else {
                // 2名以上の場合、自分以外を評価
                const evaluationCount = count - 1;
                let allSelected = true;
                for (let i = 0; i < evaluationCount; i++) {
                    const memberSelected = document.querySelector(`select[name="participant_${i}_member"]`)?.value;
                    const contributionSelected = document.querySelector(`input[name="participant_${i}_contribution"]:checked`);
                    if (!memberSelected || !contributionSelected) {
                        allSelected = false;
                        break;
                    }
                }
                membersComplete = allSelected;
            }
        }
        document.querySelector('#progressMembers input').checked = membersComplete;
        
        // 1位選択チェック
        const firstSelected = document.getElementById('first_place_group').value;
        document.querySelector('#progressFirst input').checked = !!firstSelected;
        
        // 2位選択チェック
        const secondSelected = document.getElementById('second_place_group').value;
        document.querySelector('#progressSecond input').checked = !!secondSelected;
        
        // 提出ボタン有効/無効
        const allComplete = groupSelected && membersComplete && firstSelected && secondSelected;
        document.getElementById('submitButton').disabled = !allComplete;
    }

    // 1位選択時に2位の選択肢を更新
    function updateSecondPlaceOptions() {
        const firstSelect = document.getElementById('first_place_group');
        const secondSelect = document.getElementById('second_place_group');
        const selectedFirst = firstSelect.value;
        const currentSecond = secondSelect.value;
        
        // 2位の選択肢をリセット
        secondSelect.innerHTML = '<option value="">選択してください</option>';
        
        if (selectedFirst) {
            // 1位で選択されたグループ以外を2位の選択肢に追加
            groupsData.forEach(group => {
                if (group.id != selectedFirst) {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name || `${group.id}グループ`;
                    secondSelect.appendChild(option);
                }
            });
            
            // 2位が既に選択されていて、1位と同じグループだった場合はリセット
            if (currentSecond === selectedFirst) {
                secondSelect.value = '';
            } else if (currentSecond && currentSecond !== selectedFirst) {
                // 2位が既に選択されていて、1位と異なる場合は保持
                secondSelect.value = currentSecond;
            }
        } else {
            // 1位が選択されていない場合は全てのグループを表示
            groupsData.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name || `${group.id}グループ`;
                secondSelect.appendChild(option);
            });
            
            // 2位の選択を保持
            if (currentSecond) {
                secondSelect.value = currentSecond;
            }
        }
        
        updateProgress();
    }

    // 2位選択時に1位の選択肢を更新
    function updateFirstPlaceOptions() {
        const firstSelect = document.getElementById('first_place_group');
        const secondSelect = document.getElementById('second_place_group');
        const selectedSecond = secondSelect.value;
        const currentFirst = firstSelect.value;
        
        // 1位の選択肢をリセット
        firstSelect.innerHTML = '<option value="">選択してください</option>';
        
        if (selectedSecond) {
            // 2位で選択されたグループ以外を1位の選択肢に追加
            groupsData.forEach(group => {
                if (group.id != selectedSecond) {
                    const option = document.createElement('option');
                    option.value = group.id;
                    option.textContent = group.name || `${group.id}グループ`;
                    firstSelect.appendChild(option);
                }
            });
            
            // 1位が既に選択されていて、2位と同じグループだった場合はリセット
            if (currentFirst === selectedSecond) {
                firstSelect.value = '';
            } else if (currentFirst && currentFirst !== selectedSecond) {
                // 1位が既に選択されていて、2位と異なる場合は保持
                firstSelect.value = currentFirst;
            }
        } else {
            // 2位が選択されていない場合は全てのグループを表示
            groupsData.forEach(group => {
                const option = document.createElement('option');
                option.value = group.id;
                option.textContent = group.name || `${group.id}グループ`;
                firstSelect.appendChild(option);
            });
            
            // 1位の選択を保持
            if (currentFirst) {
                firstSelect.value = currentFirst;
            }
        }
        
        updateProgress();
    }

    // イベントリスナー設定
    document.addEventListener('change', updateProgress);

    // フォーム送信時のバリデーション
    document.getElementById('evaluationForm').addEventListener('submit', function(e) {
        // 1位と2位の重複チェック
        const first = document.getElementById('first_place_group').value;
        const second = document.getElementById('second_place_group').value;
        
        if (first && second && first === second) {
            e.preventDefault();
            alert('1位と2位には異なるグループを選択してください。');
            return false;
        }
        
        // メンバー評価の重複チェック
        const participantCount = document.getElementById('participantCount').value;
        if (participantCount) {
            const count = parseInt(participantCount);
            const selectedGroupId = document.querySelector('input[name="evaluator_group"]:checked')?.value;
            
            if (selectedGroupId) {
                const group = groupsData.find(g => g.id == selectedGroupId);
                
                // グループの人数を超えている場合はエラー
                if (count > group.members.length) {
                    e.preventDefault();
                    alert(`参加者数（${count}名）がグループのメンバー数（${group.members.length}名）を超えています。`);
                    return false;
                }
                
                if (count > 1) {
                    // 2名以上の場合のみ重複チェック
                    const evaluationCount = count - 1;
                    const selectedMembers = [];
                    
                    for (let i = 0; i < evaluationCount; i++) {
                        const memberSelected = document.querySelector(`select[name="participant_${i}_member"]`)?.value;
                        if (memberSelected) {
                            if (selectedMembers.includes(memberSelected)) {
                                e.preventDefault();
                                alert('同じメンバーを複数回評価することはできません。');
                                return false;
                            }
                            selectedMembers.push(memberSelected);
                        }
                    }
                }
            }
            // 1名の場合はメンバー評価をスキップするため、重複チェックは不要
        }
    });
    </script>
    {% endif %}
</body>
</html>
