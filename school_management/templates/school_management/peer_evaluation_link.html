{% extends 'school_management/base.html' %}

{% block title %}ピア評価リンク作成 - {{ session.classroom.class_name }} 第{{ session.session_number }}回{% endblock %}
{% block page_title %}匿名ピア評価リンク{% endblock %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-md-10">
            <!-- セッション情報 -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="fas fa-calendar me-2"></i>授業情報</h6>
                            <p class="mb-1"><strong>授業:</strong> {{ session.classroom.class_name }}</p>
                            <p class="mb-1"><strong>回:</strong> 第{{ session.session_number }}回</p>
                            <p class="mb-0"><strong>日付:</strong> {{ session.date|date:"Y年m月d日" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="fas fa-users me-2"></i>対象</h6>
                            <p class="mb-0">この授業を履修している全学生</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 匿名評価リンク -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-link me-2"></i>匿名評価リンク</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>使用方法</h6>
                        <p class="mb-2">以下のリンクを学生に共有してください。学生は匿名でピア評価を行うことができます。</p>
                        <ul class="mb-0">
                            <li>学生の名前や学籍番号は記録されません</li>
                            <li>評価は完全に匿名で処理されます</li>
                            <li>各学生は1回のみ評価を行うことができます</li>
                        </ul>
                    </div>
                    
                    <!-- リンクURL表示 -->
                    <div class="mb-3">
                        <label class="form-label"><strong>評価フォームURL</strong></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="evaluation-url" 
                                   value="{{ anonymous_url }}" readonly>
                            <button class="btn btn-outline-secondary" type="button" onclick="copyUrl()">
                                <i class="fas fa-copy"></i> コピー
                            </button>
                        </div>
                    </div>
                    
                    <!-- QRコード表示エリア -->
                    <div class="text-center mb-3">
                        <div id="qrcode" class="d-inline-block"></div>
                        <p class="text-muted mt-2">QRコードをスキャンして評価フォームにアクセス</p>
                    </div>
                    
                    <!-- 共有ボタン -->
                    <div class="text-center">
                        <button class="btn btn-success me-2" onclick="shareByEmail()">
                            <i class="fas fa-envelope me-2"></i>メールで送信
                        </button>
                        <button class="btn btn-info me-2" onclick="shareByLine()">
                            <i class="fab fa-line me-2"></i>LINEで共有
                        </button>
                        <button class="btn btn-warning me-2" onclick="shareByTeams()">
                            <i class="fab fa-microsoft me-2"></i>Teamsで共有
                        </button>
                        <button class="btn btn-secondary" onclick="window.print()">
                            <i class="fas fa-print me-2"></i>印刷
                        </button>
                    </div>
                </div>
            </div>

            <!-- 評価設定 -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-cog me-2"></i>評価設定</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>評価項目</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-check text-success me-2"></i>グループメンバーの貢献度（1-5段階）</li>
                                <li><i class="fas fa-check text-success me-2"></i>他グループの1位・2位選択</li>
                                <li><i class="fas fa-check text-success me-2"></i>選択理由（自由記述）</li>
                                <li><i class="fas fa-check text-success me-2"></i>授業へのコメント（任意）</li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6>匿名性保証</h6>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-shield-alt text-success me-2"></i>評価者の身元は記録されません</li>
                                <li><i class="fas fa-user-secret text-success me-2"></i>ログイン不要</li>
                                <li><i class="fas fa-lock text-success me-2"></i>IPアドレスも記録されません</li>
                                <li><i class="fas fa-eye-slash text-success me-2"></i>完全匿名システム</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 評価結果へのリンク -->
            <div class="card">
                <div class="card-body text-center">
                    <h6>評価管理</h6>
                    <a href="{% url 'school_management:peer_evaluation_results' session.id %}" class="btn btn-primary me-2">
                        <i class="fas fa-chart-bar me-2"></i>評価結果を確認
                    </a>
                    <a href="{% url 'school_management:session_detail' session.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>授業詳細に戻る
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
#qrcode {
    border: 2px solid #dee2e6;
    padding: 10px;
    border-radius: 8px;
    background-color: white;
}

@media print {
    .btn, .card-header {
        color-adjust: exact !important;
        -webkit-print-color-adjust: exact !important;
    }
    
    .no-print {
        display: none !important;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<!-- QRCode.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // QRコード生成
    const qrCodeDiv = document.getElementById('qrcode');
    const evaluationUrl = '{{ anonymous_url }}';
    
    QRCode.toCanvas(qrCodeDiv, evaluationUrl, {
        width: 200,
        margin: 2,
        color: {
            dark: '#000000',
            light: '#FFFFFF'
        }
    }, function (error) {
        if (error) {
            console.error('QRコード生成エラー:', error);
            qrCodeDiv.innerHTML = '<p class="text-danger">QRコードの生成に失敗しました</p>';
        }
    });
});

function copyUrl() {
    const urlInput = document.getElementById('evaluation-url');
    urlInput.select();
    urlInput.setSelectionRange(0, 99999); // モバイル対応
    
    navigator.clipboard.writeText(urlInput.value).then(function() {
        // 成功メッセージ
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> コピー済み';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(function() {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }).catch(function(err) {
        alert('URLのコピーに失敗しました: ' + err);
    });
}

function shareByEmail() {
    const url = '{{ anonymous_url }}';
    const subject = encodeURIComponent('ピア評価フォーム - {{ session.classroom.class_name }} 第{{ session.session_number }}回');
    const body = encodeURIComponent(`{{ session.classroom.class_name }} 第{{ session.session_number }}回のピア評価フォームです。

以下のリンクからアクセスして評価を行ってください：
${url}

※この評価は匿名で行われます。
※評価期限については別途お知らせします。`);
    
    window.open(`mailto:?subject=${subject}&body=${body}`);
}

function shareByLine() {
    const url = '{{ anonymous_url }}';
    const text = encodeURIComponent(`{{ session.classroom.class_name }} 第{{ session.session_number }}回のピア評価フォームです。匿名で評価できます。`);
    
    window.open(`https://social-plugins.line.me/lineit/share?url=${encodeURIComponent(url)}&text=${text}`);
}

function shareByTeams() {
    const url = '{{ anonymous_url }}';
    const text = encodeURIComponent(`{{ session.classroom.class_name }} 第{{ session.session_number }}回のピア評価フォーム`);
    
    window.open(`https://teams.microsoft.com/share?msgText=${text}&href=${encodeURIComponent(url)}`);
}
</script>
{% endblock %}
