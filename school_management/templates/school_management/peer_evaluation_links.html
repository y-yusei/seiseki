{% extends 'school_management/base.html' %}

{% block title %}ピア評価リンク一覧 - {{ lesson_session.classroom.class_name }}{% endblock %}
{% block page_title %}ピア評価リンク一覧{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-link me-2"></i>ピア評価リンク一覧</h5>
                <div>
                    <a href="{% url 'school_management:lesson_session_detail' lesson_session.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="text-primary mb-2"><i class="fas fa-info-circle me-2"></i>授業情報</h6>
                            <div>
                                <strong>クラス:</strong> {{ lesson_session.classroom.class_name }}<br>
                                <strong>授業回:</strong> 第{{ lesson_session.session_number }}回<br>
                                <strong>実施日:</strong> {{ lesson_session.date|date:"Y年m月d日" }}<br>
                                <strong>トピック:</strong> {{ lesson_session.topic|default:"未設定" }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="text-primary mb-2"><i class="fas fa-chart-bar me-2"></i>評価状況</h6>
                            <div>
                                <strong>作成済み評価:</strong> {{ evaluations.count }}件<br>
                                <strong>状態:</strong> 
                                {% if evaluations.count > 0 %}
                                    <span class="badge bg-success">配布可能</span>
                                {% else %}
                                    <span class="badge bg-secondary">未作成</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if evaluations.count > 0 %}
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>使用方法</h6>
                        <p class="mb-2">以下のリンクを各グループに共有してください。</p>
                        <ul class="mb-0">
                            <li>各グループ専用の評価フォームリンクです</li>
                            <li>グループメンバーは匿名でピア評価を行えます</li>
                            <li>評価は完全に匿名で処理されます</li>
                        </ul>
                    </div>

                    <div class="row">
                        {% for evaluation in evaluations %}
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="fas fa-users me-2"></i>
                                        {% if evaluation.evaluator_group.group_name %}
                                            {{ evaluation.evaluator_group.group_name }} ({{ evaluation.evaluator_group.group_number }}グループ)
                                        {% else %}
                                            {{ evaluation.evaluator_group.group_number }}グループ
                                        {% endif %}
                                    </h6>
                                    <span class="badge bg-light text-primary">
                                        {{ evaluation.evaluator_group.groupmember_set.count }}名
                                    </span>
                                </div>
                                <div class="card-body">
                                    <!-- グループメンバー表示 -->
                                    <div class="mb-3">
                                        <small class="text-muted">メンバー:</small><br>
                                        {% for member in evaluation.evaluator_group.groupmember_set.all %}
                                            <span class="badge bg-light text-dark me-1">{{ member.student.full_name }}</span>
                                        {% endfor %}
                                    </div>

                                    <!-- 評価フォームURL -->
                                    <div class="mb-3">
                                        <div class="small mb-1"><strong>評価フォームURL</strong></div>
                                        <div class="input-group input-group-sm">
                                            <input type="text" class="form-control" 
                                                   id="url-{{ evaluation.evaluator_group.id }}"
                                                   value="http://{{ request.get_host }}{% url 'school_management:improved_peer_evaluation_form' evaluation.evaluator_token %}"
                                                   readonly>
                                            <button class="btn btn-outline-secondary" type="button" 
                                                    onclick="copyUrl('url-{{ evaluation.evaluator_group.id }}')">
                                                <i class="fas fa-copy"></i>
                                            </button>
                                        </div>
                                    </div>

                                    <!-- アクションボタン -->
                                    <div class="d-grid gap-1">
                                        <a href="{% url 'school_management:improved_peer_evaluation_form' evaluation.evaluator_token %}" 
                                           class="btn btn-sm btn-success" target="_blank">
                                            <i class="fas fa-external-link-alt me-1"></i>プレビュー
                                        </a>
                                        <button class="btn btn-sm btn-outline-primary" 
                                                onclick="shareUrl('{{ evaluation.evaluator_group.group_number }}グループ', 'url-{{ evaluation.evaluator_group.id }}')">
                                            <i class="fas fa-share me-1"></i>共有
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted small">
                                    <i class="fas fa-key me-1"></i>トークン: {{ evaluation.evaluator_token|truncatechars:8 }}...
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-circle fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">ピア評価リンクがありません</h5>
                        <p class="text-muted mb-3">まずピア評価を作成してください。</p>
                        <a href="{% url 'school_management:improved_peer_evaluation_create' lesson_session.id %}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>ピア評価を作成
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- 統計情報 -->
        {% if evaluations.count > 0 %}
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-chart-pie me-2"></i>配布統計</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>作成済みリンク</span>
                        <strong class="text-primary">{{ evaluations.count }}件</strong>
                    </div>
                    <div class="progress">
                        <div class="progress-bar bg-primary" style="width: 100%"></div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">グループ別</small>
                    {% for evaluation in evaluations %}
                    <div class="d-flex justify-content-between small mb-1">
                        <span>{{ evaluation.evaluator_group.group_number }}グループ</span>
                        <span class="badge bg-success">配布済み</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}

        <!-- アクションカード -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-tools me-2"></i>アクション</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'school_management:improved_peer_evaluation_create' lesson_session.id %}" class="btn btn-primary btn-sm">
                        <i class="fas fa-plus me-1"></i>新しい評価を作成
                    </a>
                    <a href="{% url 'school_management:group_management' lesson_session.id %}" class="btn btn-outline-info btn-sm">
                        <i class="fas fa-users me-1"></i>グループ編成
                    </a>
                    <button class="btn btn-outline-secondary btn-sm" onclick="alert('結果確認機能は実装中です')">
                        <i class="fas fa-chart-bar me-1"></i>結果確認
                    </button>
                </div>
            </div>
        </div>

        <!-- ヘルプカード -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-question-circle me-2"></i>ヘルプ</h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">リンクの使用方法</h6>
                <div class="mb-2">
                    <strong>コピー:</strong>
                    <small class="d-block text-muted">URLをクリップボードにコピー</small>
                </div>
                <div class="mb-2">
                    <strong>プレビュー:</strong>
                    <small class="d-block text-muted">実際の評価フォームを確認</small>
                </div>
                <div class="mb-3">
                    <strong>共有:</strong>
                    <small class="d-block text-muted">メールやチャットで共有</small>
                </div>
                
                <hr>
                
                <h6 class="text-primary">注意事項</h6>
                <ul class="small mb-0">
                    <li>各グループごとに専用URLが生成されます</li>
                    <li>URLを知っている人は誰でもアクセス可能です</li>
                    <li>評価は匿名で処理されます</li>
                    <li>一度作成したリンクは変更できません</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// URLをクリップボードにコピー
function copyUrl(inputId) {
    const input = document.getElementById(inputId);
    input.select();
    input.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        // 成功時の視覚的フィードバック
        const button = input.nextElementSibling;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 1500);
    } catch (err) {
        console.error('コピーに失敗しました:', err);
        alert('URLのコピーに失敗しました。手動でコピーしてください。');
    }
}

// URLを共有（ブラウザの共有API使用、対応していない場合はクリップボードにコピー）
function shareUrl(groupName, inputId) {
    const url = document.getElementById(inputId).value;
    const title = `${groupName} ピア評価フォーム`;
    const text = `{{ lesson_session.classroom.class_name }} 第{{ lesson_session.session_number }}回のピア評価フォームです。`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url
        }).then(() => {
            console.log('共有が完了しました');
        }).catch((error) => {
            console.error('共有に失敗しました:', error);
            copyUrl(inputId);
        });
    } else {
        // 共有APIが使用できない場合はクリップボードにコピー
        copyUrl(inputId);
    }
}

// 全URLを一括コピー（デバッグ用）
function copyAllUrls() {
    let allUrls = '';
    const inputs = document.querySelectorAll('input[id^="url-"]');
    inputs.forEach((input, index) => {
        const groupNumber = index + 1;
        allUrls += `${groupNumber}グループ: ${input.value}\n`;
    });
    
    navigator.clipboard.writeText(allUrls).then(() => {
        alert('全URLをクリップボードにコピーしました');
    }).catch(err => {
        console.error('コピーに失敗しました:', err);
    });
}
</script>
{% endblock %}
