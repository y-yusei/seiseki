{% extends 'school_management/base.html' %}

{% block title %}ピア評価作成 - {{ lesson_session.classroom.class_name }}{% endblock %}
{% block page_title %}ピア評価作成{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-users-cog me-2"></i>ピア評価作成</h5>
                <div>
                    <a href="{% url 'school_management:lesson_session_detail' lesson_session.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>戻る
                    </a>
                </div>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="text-primary mb-2"><i class="fas fa-info-circle me-2"></i>授業情報</h6>
                            <div>
                                <strong>クラス:</strong> {{ lesson_session.classroom.class_name }}<br>
                                <strong>授業回:</strong> 第{{ lesson_session.session_number }}回<br>
                                <strong>実施日:</strong> {{ lesson_session.date|date:"Y年m月d日" }}<br>
                                <strong>トピック:</strong> {{ lesson_session.topic|default:"未設定" }}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 bg-light rounded">
                            <h6 class="text-primary mb-2"><i class="fas fa-users me-2"></i>グループ情報</h6>
                            <div>
                                <strong>グループ数:</strong> {{ groups.count }}グループ<br>
                                <strong>学生数:</strong> {{ students.count }}名<br>
                                <strong>状態:</strong> 
                                {% if groups.count > 0 %}
                                    <span class="badge bg-success">グループ編成済み</span>
                                {% else %}
                                    <span class="badge bg-warning">未編成</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                {% if groups.count == 0 %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ピア評価を作成する前に、グループを編成してください。
                        <a href="{% url 'school_management:group_management' lesson_session.id %}" class="btn btn-sm btn-warning ms-2">
                            <i class="fas fa-users me-1"></i>グループ編成
                        </a>
                    </div>
                {% else %}
                        <div class="mb-4">
                            <h6><i class="fas fa-link me-2"></i>ピア評価URL（この授業専用）</h6>
                            <p class="text-muted mb-3">
                                この授業全体で共通のピア評価URLです。学生はこのURLにアクセスし、自分のグループを選択してから評価を行います。
                                <br><strong>※この授業のすべてのグループが同じURLを使用します。</strong>
                            </p>
                            
                            <div class="input-group">
                                <input type="text" class="form-control" id="common-url" 
                                       value="http://{{ request.get_host }}{% url 'school_management:peer_evaluation_common' lesson_session.id %}"
                                       readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="copyCommonUrl()">
                                    <i class="fas fa-copy"></i> コピー
                                </button>
                            </div>
                            
                            <div class="mt-3">
                                <a href="{% url 'school_management:peer_evaluation_common' lesson_session.id %}" 
                                   class="btn btn-sm btn-success me-2" target="_blank">
                                    <i class="fas fa-external-link-alt me-1"></i>フォームをプレビュー
                                </a>
                                <button class="btn btn-sm btn-outline-primary" onclick="shareCommonUrl()">
                                    <i class="fas fa-share me-1"></i>URLを共有
                                </button>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <p class="text-muted mb-3">学生は上記のURLからピア評価を行います</p>
                            
                            <!-- 締切状態の表示と制御 -->
                            <div class="mb-3">
                                {% if lesson_session.peer_evaluation_closed %}
                                    <div class="alert alert-danger">
                                        <i class="fas fa-lock me-2"></i>ピア評価は締め切られています
                                    </div>
                                    <form method="post" action="{% url 'school_management:reopen_peer_evaluation' lesson_session.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-success me-2" onclick="return confirm('ピア評価を再開しますか？')">
                                            <i class="fas fa-unlock me-2"></i>評価を再開する
                                        </button>
                                    </form>
                                {% else %}
                                    <div class="alert alert-success">
                                        <i class="fas fa-unlock me-2"></i>ピア評価は受付中です
                                    </div>
                                    <form method="post" action="{% url 'school_management:close_peer_evaluation' lesson_session.id %}" style="display: inline;">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger me-2" onclick="return confirm('ピア評価を締め切りますか？学生は評価できなくなります。')">
                                            <i class="fas fa-lock me-2"></i>評価を締め切る
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                            
                            <div class="d-flex justify-content-center gap-2">
                                <a href="{% url 'school_management:lesson_session_detail' lesson_session.id %}" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>戻る
                                </a>
                                <a href="{% url 'school_management:peer_evaluation_results' lesson_session.id %}" class="btn btn-info btn-lg">
                                    <i class="fas fa-chart-bar me-2"></i>結果を確認
                                </a>
                            </div>
                        </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- グループ一覧 -->
        <div class="card mb-4">
            <div class="card-header">
                <h6><i class="fas fa-users me-2"></i>グループ一覧</h6>
            </div>
            <div class="card-body">
                {% if groups %}
                    {% for group in groups %}
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-1">
                                    {% if group.group_name %}
                                        {{ group.group_name }} ({{ group.group_number }}グループ)
                                    {% else %}
                                        {{ group.group_number }}グループ
                                    {% endif %}
                                </h6>
                                <span class="badge bg-primary">{{ group.groupmember_set.count }}名</span>
                            </div>
                            <div class="small text-muted">
                                {% for member in group.groupmember_set.all %}
                                    {{ member.student.full_name }}{% if not forloop.last %}, {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% if not forloop.last %}<hr>{% endif %}
                    {% endfor %}
                {% else %}
                    <p class="text-muted">グループが編成されていません。</p>
                    <a href="{% url 'school_management:group_management' lesson_session.id %}" class="btn btn-sm btn-primary">
                        <i class="fas fa-users me-1"></i>グループ編成
                    </a>
                {% endif %}
            </div>
        </div>

        <!-- ヘルプ -->
        <div class="card">
            <div class="card-header">
                <h6><i class="fas fa-question-circle me-2"></i>ピア評価について</h6>
            </div>
            <div class="card-body">
                <h6 class="text-primary">評価機能</h6>
                <div class="mb-2">
                    <strong>グループ内貢献度:</strong>
                    <small class="d-block text-muted">同じグループメンバーの作業への貢献を5段階で評価</small>
                </div>
                <div class="mb-2">
                    <strong>他グループランキング:</strong>
                    <small class="d-block text-muted">発表内容やアイデアの良さを評価</small>
                </div>
                <div class="mb-3">
                    <strong>参加人数記録:</strong>
                    <small class="d-block text-muted">実際に活動に参加したメンバー数を記録</small>
                </div>
                
                <hr>
                
                <h6 class="text-primary">使用方法</h6>
                <ul class="small mb-0">
                    <li><strong>授業全体で一つのURL</strong>を学生全員に共有してください</li>
                    <li>学生は最初に自分のグループを選択します</li>
                    <li>その後、グループメンバーの貢献度を評価します</li>
                    <li>最後に他グループのランキングを付けます</li>
                    <li>評価は1人1回まで、匿名で行われます</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// 今日から1週間後をデフォルト期限に設定
document.addEventListener('DOMContentLoaded', function() {
    const deadlineInput = document.getElementById('deadline');
    if (deadlineInput) {
        const nextWeek = new Date();
        nextWeek.setDate(nextWeek.getDate() + 7);
        nextWeek.setHours(23, 59, 0, 0); // 23:59に設定
        
        // datetime-local形式に変換
        const year = nextWeek.getFullYear();
        const month = String(nextWeek.getMonth() + 1).padStart(2, '0');
        const day = String(nextWeek.getDate()).padStart(2, '0');
        const hours = String(nextWeek.getHours()).padStart(2, '0');
        const minutes = String(nextWeek.getMinutes()).padStart(2, '0');
        
        deadlineInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
});

// 共通URLをクリップボードにコピー
function copyCommonUrl() {
    const input = document.getElementById('common-url');
    input.select();
    input.setSelectionRange(0, 99999);
    
    try {
        document.execCommand('copy');
        // 成功時の視覚的フィードバック
        const button = input.nextElementSibling;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i> コピー済み';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    } catch (err) {
        console.error('コピーに失敗しました:', err);
        alert('URLのコピーに失敗しました。手動でコピーしてください。');
    }
}

// URLを共有
function shareCommonUrl() {
    const url = document.getElementById('common-url').value;
    const title = 'ピア評価フォーム';
    const text = `{{ lesson_session.classroom.class_name }} 第{{ lesson_session.session_number }}回のピア評価フォームです。`;
    
    if (navigator.share) {
        navigator.share({
            title: title,
            text: text,
            url: url
        }).then(() => {
            console.log('共有が完了しました');
        }).catch((error) => {
            console.error('共有に失敗しました:', error);
            copyCommonUrl();
        });
    } else {
        // 共有APIが使用できない場合はクリップボードにコピー
        copyCommonUrl();
    }
}
</script>
{% endblock %}
